<!doctype html>
<meta charset="utf-8" />
<title>Secure Workspace — WebAuthn PoC</title>
<h1>WebAuthn Provisioning PoC</h1>
<button id="register">Register (Create Keys)</button>
<pre id="out"></pre>
<script>
async function buf(b64) {
  return Uint8Array.from(atob(b64.replace(/-/g,'+').replace(/_/g,'/')), c => c.charCodeAt(0));
}
async function b64(buf) {
  let s = String.fromCharCode(...new Uint8Array(buf));
  return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
async function post(url, body) {
  const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  return r.json();
}
document.getElementById('register').onclick = async () => {
  const { sessionToken, challenge } = await post('/challenge', { userId:'demo', purpose:'provision' });
  const pubKeyOpts = {
    challenge: Uint8Array.from(atob(challenge), c=>c.charCodeAt(0)),
    rp: { name: 'Secure Workspace PoC' },
    user: { id: new Uint8Array([1,2,3,4]), name: 'demo', displayName: 'demo' },
    pubKeyCredParams: [{ type:'public-key', alg: -7 }],
    attestation: 'direct',
    authenticatorSelection: { authenticatorAttachment:'platform', userVerification:'required' }
  };
  const cred = await navigator.credentials.create({ publicKey: pubKeyOpts });
  const attObj = new Uint8Array(cred.response.attestationObject);
  const clientDataJSON = new Uint8Array(cred.response.clientDataJSON);
  const payload = {
    sessionToken,
    attestation: { attestationObject: await b64(attObj), clientDataJSON: await b64(clientDataJSON) },
    publicKeyJwk: {}, // server tarafında çıkarılacak
    signedChallenge: null // server tarafı doğrular
  };
  const res = await post('/register', payload);
  document.getElementById('out').textContent = JSON.stringify(res, null, 2);
};
</script>
